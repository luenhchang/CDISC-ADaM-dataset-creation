---
title: "Creating a basic data structure (BDS) Exposure ADaM"
author: "Lun-Hsien Chang"
date: "01-Dec-2024"
toc: true
toc-depth: 2  # Levels of headings to include in TOC (e.g., 2 includes H1 and H2)
toc-title: "Programming workflow"  # Custom title for the TOC
format:
  html:
    css: styles.css  # Use custom CSS for soft-wrap in HTML
  pdf: 
    latex_engine: xelatex
    header-includes:
      - \usepackage{listings}
      - \lstset{breaklines=true, breakatwhitespace=true, basicstyle=\ttfamily\small, columns=fullflexible}
    fontsize: 11pt
    geometry: margin=1in, left=1in, right=1in, top=1in, bottom=1in
    mainfont: "Times New Roman"
    fontenc: T1
    citation_package: natbib
    urlcolor: blue       # Make URLs blue
    linkcolor: blue      # Make links in the PDF blue
    hyperref: true
  markdown:
    variant: gfm         # Use GitHub Flavored Markdown
    embed-resources: true # Embed images and other resources
output-dir: "outputs"
editor: visual
source: "https://cran.r-project.org/web/packages/admiral/vignettes/bds_exposure.html"
---

Get required R packages

```{r}
#| echo: false
library(admiral)
library(dplyr, warn.conflicts = FALSE)
library(pharmaversesdtm)
library(lubridate)
library(stringr)
library(tibble)
```

# Read CDISC pilot SDTM and ADaM datasets

```{r}
#| echo: false
data("admiral_adsl")
data("ex")

adsl <- admiral_adsl # dim(adsl) 306 50
ex <- convert_blanks_to_na(ex) # dim(ex) 591 17
```

```{r}
#| wrap: true
adsl_vars <- exprs(TRTSDT, TRTSDTM, TRTEDT, TRTEDTM)

# left join EX and adsl TRTSDT, TRTSDTM, TRTEDT, TRTEDTM on ex.STUDYID=adslSTUDYID and ex.USUBJID=adsl.USUBJID
adex <- derive_vars_merged(
   dataset=ex
  ,dataset_add = adsl
  ,new_vars = adsl_vars
  ,by_vars = exprs(STUDYID, USUBJID)
  ) # dim(adex) 591 21
```

The CDISC pilot `EX` domain data does not contain a dose adjustment flag or the planned dose information. For demonstration purposes, this will be added to the data.

## EXADJ

-   Exposure Adjustment ?

## EXDOSE

-   exposure dose

-   from SDTM.EX.EXDOSE

## EXPLDOS

-   Planned Dose

```{r}
adex <- adex %>%
  mutate(
    EXADJ = case_when(
      USUBJID == "01-701-1028" & VISIT %in% c("WEEK 2") ~ "ADVERSE EVENT",
      USUBJID == "01-701-1148" & VISIT %in% c("WEEK 2", "WEEK 24") ~ "MEDICATION ERROR",
      TRUE ~ NA_character_
    ),
    EXDOSE = case_when(
      USUBJID == "01-701-1028" & VISIT %in% c("WEEK 2") ~ 0,
      USUBJID == "01-701-1148" & VISIT %in% c("WEEK 2", "WEEK 24") ~ 0,
      TRUE ~ EXDOSE
    )
  ) %>%
  mutate(EXPLDOS = if_else(EXTRT == "PLACEBO", 0, 54))

adex %>% select(EXTRT, EXPLDOS) %>% distinct()
```

# Derive numeric datetime, analysis day variables

## ASTDT

-   Analysis Start Date

-   Set to a numeric form of EX.EXSTDTC when EX.EXSTDTC consists of a full date.

## AENDT

-   Analysis End Date

-   Set to a numeric form of EX.EXENDTC when EX.EXENDTC consists of a full date.

```{r}
# Convert character datetime to numeric datetime
adex <- derive_vars_dt(adex, new_vars_prefix = "AST", dtc = EXSTDTC)
adex <- derive_vars_dt(adex, new_vars_prefix = "AEN", dtc = EXENDTC) # dim(adex) 591 25
adex %>% select(USUBJID,VISIT,EXSTDTC,EXENDTC,ASTDT,AENDT) %>% head()
```

## ASTDTM

## AENDTM

The next examples demonstrates the datetime imputation features available in the `derive_vars_dtm()` function, where the time is imputed as “00:00:00”:

```{r}
adex <- derive_vars_dtm(
  adex
  ,dtc = EXSTDTC
  # Impute dtc date to the first day of the month
  ,highest_imputation = "M"
  ,date_imputation = "first"
  ,new_vars_prefix = "AST"
)

adex <- derive_vars_dtm(
  adex,
  dtc = EXENDTC,
  # Impute dtc date to the last day of the month
  highest_imputation = "M",
  date_imputation = "last",
  new_vars_prefix = "AEN"
)

adex %>% select(EXSTDTC,EXENDTC,ASTDTM,AENDTM) %>% head()
```

## ASTDY

-   Analysis Start Day

-   \`ASTDT-TRTSDT+1\`

## AENDY

-   Analysis End Day

-   \`AENDT-TRTSDT+1\`

```{r}
adex <- derive_vars_dy(
  dataset=adex
  ,reference_date = TRTSDT
  ,source_vars = exprs(ASTDT, AENDT)
  ) # dim(adex) 591 33
adex %>% select(TRTSDT, ASTDT, ASTDY, AENDT, AENDY) %>% head()
```

## EXDURD

-   Duration of treatment or exposure

-   \`EXDURD=AENDT - ASTDT +1\`

```{r}
adex <- adex %>%
  derive_vars_duration(
    new_var = EXDURD
    ,start_date = ASTDT
    ,end_date = AENDT 
    # duration unit can be "years", "months", "weeks", "days", "hours", "minutes", "seconds"
    ,out_unit = "DAYS")

adex %>% select(ASTDT, AENDT, EXDURD) %>% head()
```

## DOSEO

-   `EXDOSE * EXDURD`

## PDOSEO

-   \`EXPLDOS \* EXDURD\`

```{r}
adex <- adex %>%
  mutate(
    DOSEO = EXDOSE * EXDURD
    ,PDOSEO = EXPLDOS * EXDURD)

adex %>% select(USUBJID, EXDOSE, EXPLDOS, EXDURD, DOSEO, PDOSEO) %>% head()
```

# References

[Creating a BDS Exposure ADaM](https://cran.r-project.org/web/packages/admiral/vignettes/bds_exposure.html)

[ADaM Subject-level Analysis - ADSL Dataset](https://www.cdisc.org/kb/examples/adam-subject-level-analysis-adsl-dataset-80283806)
